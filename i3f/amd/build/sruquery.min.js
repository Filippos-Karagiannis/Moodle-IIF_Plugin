define("mod_i3f/sruquery",["jquery"],function(R){return{init:function(){R("#id_build_form").click(function(e){var n,i,s,l,d,c,p,v,u,b,t,h,f;R("#searchformMetadata").remove(),R("#searchResult").remove(),s="relevance",l="asc",c=d=0,v=p=i=1,u="+sortBy+relevance",b="%2Fasc",t=R("#fitem_id_build_form"),h=R('form.mform input[name="pluginfile_url"]').val(),f="https://visuallibrary.net/sru?operation=explain",R.ajax({url:h,method:"POST",cache:!1,data:{link:f}}).done(function(e){console.log(e),e=R.parseXML(e);var v=R('<table id="searchformMetadata" style="border-collapse: collapse" />'),u=R(e).find("zr\\:configInfo"),a=(a=R(u).find("zr\\:default[type='skipInSearchForm']").text()).split(",");R(e).find("zr\\:indexInfo zr\\:index").each(function(e,t){0<R.inArray(R(t).attr("id"),a)&&R(t).remove()}),console.log(e),v.append('<tr><th align="left" style="padding-bottom: 20px;padding-right: 8px;">Relation</th><th align="left" style="padding-bottom: 20px;">Search in</th><th align="left" style="padding-bottom: 20px;">Term</th></tr>');var h=R(e).find("zr\\:index zr\\:map:first-child zr\\:name");console.log(a),h.each(function(e,t){function r(e){return R(e).attr("set")+"."+R(e).text()}var o=r(t),n=R('<select class="sruIndex"id="index'+ ++e+'" name="index'+e+'" />');h.each(function(e,t){var a=R("<option/>");a.val(r(t)),a.text(R(t).text()),r(t)==o&&a.attr("selected","selected"),n.append(a)});var i=R('<select class="sruBool" name="bool'+e+'"/>'),s=R(u.find("zr\\:default[type='booleanOperator']")),a=R("<td/>");0!=s.length&&u.find("zr\\:supports[type='booleanOperator']").each(function(e,t){var a=R("<option/>"),r=R(t).text();return a.val(r),a.text(r),a.text()==s.text()&&a.attr("selected","selected"),i.append(a),i});var a=R("<td/>"),l=R("<td/>"),d=R("<tr/>");a.append(i),l.append(n),d.append(a),d.append(l);var c=R("<td/>"),p=R('<input type="text" name="term'+e+'" maxlength="2069" value="" size="30" />');c.append(p),d.append(c),v.append(d)}),t.append(v),R("[name='bool1']").remove()}),R("#id_search_vl").click(function t(){var m="https://visuallibrary.net";f=m+"/sru?operation=searchRetrieve&query=%28";var a,r,o=0;R("input[name^='term']").each(function(e,t){r=R("[name = 'index"+ ++e+"']").val()+"%3D",a=R("[name = 'bool"+e+"']").val()+"+",0<=R(t).val().indexOf(" ")?(R(t).val()&&1==o&&(f+="+"+a+r+"%28"+R(t).val()+"%29"),R(t).val()&&0==o&&(f+=r+"%28"+R(t).val()+"%29",o=1)):(R(t).val()&&1==o&&(f+="+"+a+r+R(t).val()),R(t).val()&&0==o&&(f+=r+R(t).val(),o=1))}),f=f.split(" ").join("+"),f+="%29",f+=u+b,f+="&format=json",d==p?(f+="&startRecord="+(i+10),p++):c==v?(f+="&startRecord="+(i-10),v++):f+="&startRecord="+i,console.log(f),R.ajax({url:h,method:"POST",cache:!1,data:{link:f}}).done(function(e){R("#searchformMetadata:first + ul#searchResult").remove(),R("#forward").remove(),R("#back").remove(),R("#sortby").remove(),R("#orderby").remove(),R("ul#searchResult").remove(),R("#searchformMetadata:first").append("<button type='button' id='back'><---</button> <button type='button' id='forward'>---\x3e</button>"),R("#searchformMetadata:first").append("<select name='sort' id='sortby'><option value='relevance'>Relevance</option><option value='dc.title'>Title</option><option value='bib.personalName'>Author / Collaborator</option><option value='bib.originPlace'>Place</option><option value='vl.printer-publisher'>Printer / Publisher</option><option value='dc.date'>Year</option></select>"),R("#searchformMetadata:first").append("<select name='order' id='orderby'><option value='asc'>Ascending</option><option value='desc'>Descending</option>"),R("#sortby").val(s).prop("selected",!0),R("#orderby").val(l).prop("selected",!0);var h=e,h=jQuery.parseJSON(h);console.log(h),n=h.searchRetrieveResponse.numberOfRecords,i=h.searchRetrieveResponse.echoedSearchRetrieveRequest.startRecord,R("#forward").click(function(){i+10<=n&&(d++,t())}),R("#back").click(function(){0<=i-10&&(c++,t())}),R("#sortby").change(function(){s=R(this).val(),u="+sortBy+"+s,t()}),R("#orderby").change(function(){l=R(this).val(),b="%2F"+l,t()}),0==n&&(R("#searchformMetadata:first + ul#searchResult").remove(),R("#forward").remove(),R("#back").remove(),R("#sortby").remove(),R("#orderby").remove(),R("<ul class='listres' id=searchResult>this query yielded no results </ul>").insertAfter("#searchformMetadata"));var f=R("<ul class='listres' id='searchResult'/>");R.each(h.searchRetrieveResponse.records,function(e){var t=h.searchRetrieveResponse.records[e].metadata.title,a=h.searchRetrieveResponse.records[e].metadata.subtitle,r=h.searchRetrieveResponse.records[e].metadata.author,o=h.searchRetrieveResponse.records[e].metadata.origin,n=h.searchRetrieveResponse.records[e].href.match(/(\d+)(?!.*\d)/),i=h.searchRetrieveResponse.records[e].op_ot_id,s=R("<li class='items'/>"),l="<a class='thumb' href='/ihd4/content/titleinfo/"+n[0]+"'><img src='"+m+"/static/graphics/clpx.gif' style='width:76.8px;height:116px;background-image:url(https://visuallibrary.net/s2wpihd/download/webcache/128/"+i+");'></a>",d=R("<div>"+l+"</div>");s.append(d);var c,p="<h3 class='titles'><a href="+m+"/ihd/content/titleinfo/"+n[0]+">"+t+"</a></h3>";s.append(p),c=null!=a?"<div>"+a+"</div> <div>"+r+"</div> <div>"+o+"</div>":"<div>"+r+"</div> <div>"+o+"</div>",s.append(c);var v=R('<div class="clickme">Import</div>'),u=m+"/i3f/v20/"+n[0]+"/manifest";s.append(v),v.click(function(e){e.preventDefault(),R("#id_externalurl").val(u),R("#id_intro").click()}),f.append(s)}),R(f).insertAfter("#searchformMetadata")})})})}}});